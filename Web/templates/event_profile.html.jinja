{% extends 'privileged_base.html.jinja' %}

{% block title %}
  <title>event profile of {{event_id}}</title>
{% endblock %}

{% block privileged_base_content %}
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">Attendees</h3>
    </div>
    <div class="panel-body">
      <table class="table table-hover">
        <tr>
          <th>mac_address</th>
          <th>user_name</th>
          <th>name</th>
        </tr>
        {% for record in attendees['user_mappings'] %}
          <tr class="clickable-row" href="/user/profile/{{ record['user_name'] }}">
            <td>{{record['mac_address']}}</td>
            <td><a href="/user/profile/{{ record['user_name'] }}">{{record['user_name']}}</a></td>
            <td>{{record['name']}}</td>
          </tr>
        {% endfor %}
      </table>
    </div>
  </div>
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">Interaction</h3>
    </div>
    <div class="panel-body">
      <dl class="dl-horizontal">
        <dt>start_time</dt>   <dd>{{interaction['event_start_time']}}</dd>
        <dt>end_time</dt>     <dd>{{interaction['event_end_time']}}</dd>
      </dl>
      <table class="table table-hover">
        <tr>
          <th>user1</th>
          <th>user2</th>
          <th>event_id</th>
          <th>start_time</th>
          <th>end_time</th>
        </tr>
        {% for record in interaction['interaction'] %}
          <tr>
            <td><a href="/user/profile/{{record['user1']}}">{{record['user1']}}</a></td>
            <td><a href="/user/profile/{{record['user2']}}">{{record['user2']}}</a></td>
            <td>{{record['event_id']}}</td>
            <td>{{record['start_time']}}</td>
            <td>{{record['end_time']}}</td>
          </tr>
        {% endfor %}
      </table>
    </div>
  </div>
  <div class="panel panel-primary">
    <div class="panel-heading">
      <h3 class="panel-title">Visualization</h3>
    </div>
    <div class="panel-body">
      <div id="graph"></div>
      <div id="option">
          <input name="updateButton" 
                 type="button" 
                 value="Update" 
                 onclick="updateInteraction()" />
      </div>
      <input type="text" id="myText" value="2000">
    </div>
  </div>
  <div class="panel panel-danger">
    <div class="panel-heading">
      <h3 class="panel-title">Raw interaction (for demo)</h3>
    </div>
    <div class="panel-body">
        <dt>interaction</dt>   <dd>{{interaction}}</dd>
        <dt>attendees</dt>     <dd>{{attendees}}</dd>
      </dl>
    </div>
  </div>
  <!-- Khoa script part -->
  <script type="text/javascript" src="/static/lib/d3.min.js" ></script>
  <script type="text/javascript" src="/static/lib/graph.js" ></script>
  <script type="text/javascript" src="/static/lib/get_interact_data.js" ></script>
  <script type="text/javascript" src="/static/lib/get_attendees.js" ></script>
    <style type="text/css">
        .link { stroke: #ccc; }
        .nodetext { pointer-events: none; font: 10px sans-serif; }
/*        body { width:100%; height:100%; margin:none; padding:none; }*/
        #graph { width:500px;height:500px; border:3px solid black;border-radius:12px; margin:auto; }
    </style>

  <script type="text/javascript">
  var attendees;
  var interval;
  var curr_t;
  var event_end;
  var interaction;

  graph = new myGraph("#graph");

  function buildGraph(interactionObject, attendees) {
    var interactionData = interactionObject;
      interaction = interactionData.interaction;
      attendees = attendees.user_mappings;
      
    curr_t = new Date(interactionData.event_start_time);
    event_end = new Date(interactionData.event_end_time);
    for (var i = 0; i < attendees.length; i++) {
      graph.addNode(attendees[i].user_name);
    }

    interval = parseInt(document.getElementById("myText").value);
    var myVar=setInterval(function () {updateData()}, interval);
  }

  function updateData() {
    curr_t.setTime(curr_t.getTime() + interval);
    if (curr_t.getTime() <= event_end.getTime()) {
      for (var i = 0; i < interaction.length; i++) {
        var interaction_start = new Date (interaction[i].start_time);
        var interaction_end = new Date(interaction[i].end_time);
        if ( (interaction_start.getTime() <= curr_t.getTime()) && (interaction_end.getTime() >= curr_t.getTime())) {
          graph.addLink(interaction[i].user1,interaction[i].user2);
        }
        if (interaction_end.getTime() <= curr_t.getTime()) {
          graph.removeLink(interaction[i].user1,interaction[i].user2);
        }
      }
    }
  }
  </script>
  <!-- Khoa script end part -->
  <script>
    // setTimeout(function() {
    //   window.document.location = '/dashboard';
    // }, 10 * 1000);
    updateInteraction();
    setInterval(function(){
      updateInteraction();
      // alert("Hello")
    }, 30 * 1000);

    function updateInteraction() {
      $.ajax({
        url: '/xhr/event_visualisation_data/{{event_id}}',
        success:function(result){
          buildGraph(result['interaction'], result['attendees']);
        }
      });
    }
  </script>
{% endblock %}